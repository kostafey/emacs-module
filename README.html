<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-09-03 Sun 21:00 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Writing Emacs modules useing the go programming language.</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Writing Emacs modules useing the go programming language.</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org19760db">1. Minimal Emacs module in C</a>
<ul>
<li><a href="#org868a7ce">1.1. src/cmodule.c</a></li>
<li><a href="#org471dbf2">1.2. Compiling the module</a></li>
<li><a href="#org839cfb0">1.3. Using our C module with Emacs.</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
As of Emacs version <code>25.1</code> Emacs is able to load dynamic modules. And as of
version <code>1.5</code> Go supports building packages as dynamice shared libraries.
</p>

<p>
This means in theory we can write Emacs elisp modules in pure Go.
</p>

<p>
We'll create a minimal Emacs C module, and then a Emacs module in Go.
</p>

<div id="outline-container-org19760db" class="outline-2">
<h2 id="org19760db"><span class="section-number-2">1</span> Minimal Emacs module in C</h2>
<div class="outline-text-2" id="text-1">
<p>
We'll start by writing a basic Emacs module in C.
</p>

<p>
First we'll create a top level directory and then <code>cd</code> into that directory.
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir -pv ~/src/emacs-module
<span style="color: #56b6c2;">cd</span> ~/src/emacs-module
</pre>
</div>

<p>
From here on any commands we run, will be from our top-level directory. in this
case <code>~/src/emacs-module</code>
To compile a Emacs modules we need the <code>emacs-module.h</code> header file. The header
file is found in the <code>src</code> directory of the Emacs source tarball. It's possible your
OS provides this already. However this guide is OS agnostic and we'll assume
that the header file has not been installed.
</p>

<p>
Download the emacs source tarball.
</p>
<div class="org-src-container">
<pre class="src src-shell">wget -c https://mirrors.kernel.org/gnu/emacs/emacs-25.2.tar.gz
</pre>
</div>

<p>
And then extract it.
</p>
<div class="org-src-container">
<pre class="src src-shell">tar xf emacs-25.2.tar.gz
</pre>
</div>

<p>
Create the src directory
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir src
</pre>
</div>
</div>

<div id="outline-container-org868a7ce" class="outline-3">
<h3 id="org868a7ce"><span class="section-number-3">1.1</span> src/cmodule.c</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Edit <code>src/cmodule.c</code>
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #61afef;">#include</span> <span style="color: #c678dd;">&lt;</span><span style="color: #98c379;">emacs-module.h</span><span style="color: #c678dd;">&gt;</span>
<span style="color: #61afef;">#include</span> <span style="color: #c678dd;">&lt;</span><span style="color: #98c379;">stdio.h</span><span style="color: #c678dd;">&gt;</span>

<span style="color: #61afef;">#define</span> <span style="color: #e06c75;">CMOD_VERSION</span>  <span style="color: #98c379;">"0.1"</span>

<span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">plugin_is_GPL_compatible</span>;

<span style="color: #c678dd;">static</span> <span style="color: #e5c07b;">emacs_value</span>
<span style="color: #61afef;">Fcmodule_glibc_version</span> <span style="color: #c678dd;">(</span><span style="color: #e5c07b;">emacs_env</span> *<span style="color: #e06c75;">env</span>, <span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">nargs</span>, <span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">args</span><span style="color: #61afef;">[]</span>, <span style="color: #e5c07b;">void</span> *<span style="color: #e06c75;">data</span><span style="color: #c678dd;">)</span>
<span style="color: #c678dd;">{</span>
<span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">message</span> = env-&gt;intern<span style="color: #61afef;">(</span>env, <span style="color: #98c379;">"message"</span><span style="color: #61afef;">)</span>;
<span style="color: #e5c07b;">emacs_value</span> *<span style="color: #e06c75;">string</span> = env-&gt;make_string<span style="color: #61afef;">(</span>env, CMOD_VERSION, <span style="color: #d19a66;">3</span><span style="color: #61afef;">)</span>;
env-&gt;funcall<span style="color: #61afef;">(</span>env, message, <span style="color: #d19a66;">1</span>, CMOD_VERSION<span style="color: #61afef;">)</span>;
<span style="color: #c678dd;">return</span> string;
<span style="color: #c678dd;">}</span>

<span style="color: #c678dd;">extern</span> <span style="color: #e5c07b;">int</span> <span style="color: #61afef;">emacs_module_init</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">emacs_runtime</span> *<span style="color: #e06c75;">ert</span><span style="color: #c678dd;">)</span>
<span style="color: #c678dd;">{</span>

<span style="color: #e5c07b;">emacs_env</span> *<span style="color: #e06c75;">env</span> = ert-&gt;get_environment<span style="color: #61afef;">(</span>ert<span style="color: #61afef;">)</span>;

<span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">Qfeat</span> = env-&gt;intern <span style="color: #61afef;">(</span>env, <span style="color: #98c379;">"cmodule"</span><span style="color: #61afef;">)</span>;
<span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">Qprovide</span> = env-&gt;intern <span style="color: #61afef;">(</span>env, <span style="color: #98c379;">"provide"</span><span style="color: #61afef;">)</span>;

<span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">pargs</span><span style="color: #61afef;">[]</span> = <span style="color: #61afef;">{</span> Qfeat <span style="color: #61afef;">}</span>;
env-&gt;funcall <span style="color: #61afef;">(</span>env, Qprovide, <span style="color: #d19a66;">1</span>, pargs<span style="color: #61afef;">)</span>;

printf<span style="color: #61afef;">(</span><span style="color: #98c379;">"%s\n"</span>, CMOD_VERSION<span style="color: #61afef;">)</span>;
  <span style="color: #c678dd;">return</span> <span style="color: #d19a66;">0</span>;
<span style="color: #c678dd;">}</span>
</pre>
</div>

<p>
First we include <code>emacs-module.h</code> header file.
declartion that we'll need.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #61afef;">#include</span> <span style="color: #c678dd;">&lt;</span><span style="color: #98c379;">emacs-module.h</span><span style="color: #c678dd;">&gt;</span>
<span style="color: #61afef;">#include</span> <span style="color: #c678dd;">&lt;</span><span style="color: #98c379;">stdio.h</span><span style="color: #c678dd;">&gt;</span>

<span style="color: #61afef;">#define</span> <span style="color: #e06c75;">CMOD_VERSION</span>  <span style="color: #98c379;">"0.1"</span>
</pre>
</div>

<p>
Emacs requires <code>plugin_is_GPL_compatible</code> symbol, if not declared the module
will not be loaded.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">plugin_is_GPL_compatible</span>;
</pre>
</div>

<p>
This will be the function that be called by Emacs once we have registered it.
Then function
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #c678dd;">static</span> <span style="color: #e5c07b;">emacs_value</span>
<span style="color: #61afef;">Fcmodule_glibc_version</span> <span style="color: #c678dd;">(</span><span style="color: #e5c07b;">emacs_env</span> *<span style="color: #e06c75;">env</span>, <span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">nargs</span>, <span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">args</span><span style="color: #61afef;">[]</span>, <span style="color: #e5c07b;">void</span> *<span style="color: #e06c75;">data</span><span style="color: #c678dd;">)</span>
<span style="color: #c678dd;">{</span>
<span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">message</span> = env-&gt;intern<span style="color: #61afef;">(</span>env, <span style="color: #98c379;">"message"</span><span style="color: #61afef;">)</span>;
<span style="color: #e5c07b;">emacs_value</span> *<span style="color: #e06c75;">string</span> = env-&gt;make_string<span style="color: #61afef;">(</span>env, CMOD_VERSION, <span style="color: #d19a66;">3</span><span style="color: #61afef;">)</span>;
env-&gt;funcall<span style="color: #61afef;">(</span>env, message, <span style="color: #d19a66;">1</span>, CMOD_VERSION<span style="color: #61afef;">)</span>;
<span style="color: #c678dd;">return</span> string;
<span style="color: #c678dd;">}</span>
</pre>
</div>

<p>
This function is the entry point of our module and is run when the module is first
loaded by Emacs.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #c678dd;">extern</span> <span style="color: #e5c07b;">int</span> <span style="color: #61afef;">emacs_module_init</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">emacs_runtime</span> *<span style="color: #e06c75;">ert</span><span style="color: #c678dd;">)</span>
<span style="color: #c678dd;">{</span>
</pre>
</div>

<p>
Next we need to provision the module. We'll call the elisp <code>(provide)</code> function
through the C interface. If not Emacs will error with feature not provided.
</p>

<p>
First we get the Emacs environment from the Emacs run-time.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #e5c07b;">emacs_env</span> *<span style="color: #e06c75;">env</span> = ert-&gt;get_environment<span style="color: #c678dd;">(</span>ert<span style="color: #c678dd;">)</span>;
</pre>
</div>

<p>
Then we convert our feature string into a qouted lisp symbol. The nameing is important
our module is cmodule.so so the feature symbol <b>must</b> be named <code>cmodule</code>,
anything else will not work. Then we get a quoted symbol for the elisp provide function.
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">Qfeat</span> = env-&gt;intern <span style="color: #c678dd;">(</span>env, <span style="color: #98c379;">"cmodule"</span><span style="color: #c678dd;">)</span>;
<span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">Qprovide</span> = env-&gt;intern <span style="color: #c678dd;">(</span>env, <span style="color: #98c379;">"provide"</span><span style="color: #c678dd;">)</span>;
</pre>
</div>


<p>
We then create an arguements array containing our feature symbol. And have the
Emacs environment call the provides function with our agruement. We also let
funcall know that we are passing one argument.
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #e5c07b;">emacs_value</span> <span style="color: #e06c75;">pargs</span><span style="color: #c678dd;">[]</span> = <span style="color: #c678dd;">{</span> Qfeat <span style="color: #c678dd;">}</span>;
env-&gt;funcall <span style="color: #c678dd;">(</span>env, Qprovide, <span style="color: #d19a66;">1</span>, pargs<span style="color: #c678dd;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-C">  printf<span style="color: #c678dd;">(</span><span style="color: #98c379;">"%s\n"</span>, CMOD_VERSION<span style="color: #c678dd;">)</span>;
  <span style="color: #c678dd;">return</span> <span style="color: #d19a66;">0</span>;
<span style="color: #88090B;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org471dbf2" class="outline-3">
<h3 id="org471dbf2"><span class="section-number-3">1.2</span> Compiling the module</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Create a lib directory to hold our shared libraries.
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir lib
</pre>
</div>

<p>
Now compile <code>cmodule.c</code> as a shared C library.
</p>
<div class="org-src-container">
<pre class="src src-shell">gcc -I emacs-25.2/src -fPIC -shared src/cmodule.c -o lib/cmodule.so
</pre>
</div>
</div>
</div>

<div id="outline-container-org839cfb0" class="outline-3">
<h3 id="org839cfb0"><span class="section-number-3">1.3</span> Using our C module with Emacs.</h3>
<div class="outline-text-3" id="text-1-3">
<p>
To test our module we'll start Emacs in batch mode then call our custom function.
</p>
<div class="org-src-container">
<pre class="src src-shell">emacs -Q -L ./lib -batch --eval <span style="color: #98c379;">"(require 'cmodule)"</span>
</pre>
</div>

<pre class="example">
0.1

</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2017-09-03 Sun 21:00</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
