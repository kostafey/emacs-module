<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-09-04 Mon 15:37 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Writing Emacs modules with Go</title>
<meta name="generator" content="Org mode" />
<link href="https://fonts.googleapis.com/css?family=Cabin+Sketch" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
<link href="layout.css" rel="stylesheet">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Writing Emacs modules with Go</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org79c64c8">1. Introduction</a></li>
<li><a href="#org239271e">2. Minimal Emacs module in C</a></li>
</ul>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
<div id="outline-container-org79c64c8" class="outline-2 container">
<h2 id="org79c64c8"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
As of Emacs version <code>25.1</code> Emacs is able to load dynamic modules. And as of
version <code>1.5</code> Go supports building packages as dynamice shared libraries.
</p>

<p>
This means in theory we can write Emacs elisp modules in pure Go.
</p>

<p>
We'll create a minimal Emacs C module, and then a Emacs module in Go.
</p>
</div>
</div>

<div id="outline-container-org239271e" class="outline-2 container">
<h2 id="org239271e"><span class="section-number-2">2</span> Minimal Emacs module in C</h2>
<div class="outline-text-2" id="text-2">
<p>
First we'll create a top level directory and then <code>cd</code> into that directory.
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir -pv ~/src/emacs-module
<span class="org-builtin">cd</span> ~/src/emacs-module
</pre>
</div>

<p>
From here on any commands we run, will be from our top-level directory. in this
case <code>~/src/emacs-module</code>
To compile a Emacs modules we need the <code>emacs-module.h</code> header file. The header
file is found in the <code>src</code> directory of the Emacs source tarball. It's possible your
OS provides this already. However this guide is OS agnostic and we'll assume
that the header file has not been installed.
</p>

<p>
Download the emacs source tarball.
</p>
<div class="org-src-container">
<pre class="src src-shell">wget -c https://mirrors.kernel.org/gnu/emacs/emacs-25.2.tar.gz
</pre>
</div>

<p>
And then extract it.
</p>
<div class="org-src-container">
<pre class="src src-shell">tar xf emacs-25.2.tar.gz
</pre>
</div>

<p>
Create the src directory
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir src
</pre>
</div>
</div>

<ul class="org-ul"><li><a id="org3ebda71"></a>src/cmodule.c<br /><div class="outline-text-3" id="text-org3ebda71">
<p>
Edit <code>src/cmodule.c</code>
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">emacs-module.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">CMOD_VERSION</span>  <span class="org-string">"0.1"</span>

<span class="org-type">int</span> <span class="org-variable-name">plugin_is_GPL_compatible</span>;

<span class="org-keyword">static</span> <span class="org-type">emacs_value</span>
<span class="org-function-name">Fcmodule_glibc_version</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">emacs_env</span> *<span class="org-variable-name">env</span>, <span class="org-type">int</span> <span class="org-variable-name">nargs</span>, <span class="org-type">emacs_value</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">[]</span>, <span class="org-type">void</span> *<span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-type">emacs_value</span> <span class="org-variable-name">message</span> = env-&gt;intern<span class="org-rainbow-delimiters-depth-2">(</span>env, <span class="org-string">"message"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-type">emacs_value</span> *<span class="org-variable-name">string</span> = env-&gt;make_string<span class="org-rainbow-delimiters-depth-2">(</span>env, CMOD_VERSION, <span class="org-highlight-numbers-number">3</span><span class="org-rainbow-delimiters-depth-2">)</span>;
env-&gt;funcall<span class="org-rainbow-delimiters-depth-2">(</span>env, message, <span class="org-highlight-numbers-number">1</span>, CMOD_VERSION<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-keyword">return</span> string;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">emacs_module_init</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">struct</span> <span class="org-type">emacs_runtime</span> *<span class="org-variable-name">ert</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>

<span class="org-type">emacs_env</span> *<span class="org-variable-name">env</span> = ert-&gt;get_environment<span class="org-rainbow-delimiters-depth-2">(</span>ert<span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-type">emacs_value</span> <span class="org-variable-name">Qfeat</span> = env-&gt;intern <span class="org-rainbow-delimiters-depth-2">(</span>env, <span class="org-string">"cmodule"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-type">emacs_value</span> <span class="org-variable-name">Qprovide</span> = env-&gt;intern <span class="org-rainbow-delimiters-depth-2">(</span>env, <span class="org-string">"provide"</span><span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-type">emacs_value</span> <span class="org-variable-name">pargs</span><span class="org-rainbow-delimiters-depth-2">[]</span> = <span class="org-rainbow-delimiters-depth-2">{</span> Qfeat <span class="org-rainbow-delimiters-depth-2">}</span>;
env-&gt;funcall <span class="org-rainbow-delimiters-depth-2">(</span>env, Qprovide, <span class="org-highlight-numbers-number">1</span>, pargs<span class="org-rainbow-delimiters-depth-2">)</span>;

printf<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"%s\n"</span>, CMOD_VERSION<span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">return</span> <span class="org-highlight-numbers-number">0</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
First we include <code>emacs-module.h</code> header file.
declartion that we'll need.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">emacs-module.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">stdio.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>

<span class="org-preprocessor">#define</span> <span class="org-variable-name">CMOD_VERSION</span>  <span class="org-string">"0.1"</span>
</pre>
</div>

<p>
Emacs requires <code>plugin_is_GPL_compatible</code> symbol, if not declared the module
will not be loaded.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">int</span> <span class="org-variable-name">plugin_is_GPL_compatible</span>;
</pre>
</div>

<p>
This will be the function that be called by Emacs once we have registered it.
Then function
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">static</span> <span class="org-type">emacs_value</span>
<span class="org-function-name">Fcmodule_glibc_version</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">emacs_env</span> *<span class="org-variable-name">env</span>, <span class="org-type">int</span> <span class="org-variable-name">nargs</span>, <span class="org-type">emacs_value</span> <span class="org-variable-name">args</span><span class="org-rainbow-delimiters-depth-2">[]</span>, <span class="org-type">void</span> *<span class="org-variable-name">data</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
<span class="org-type">emacs_value</span> <span class="org-variable-name">message</span> = env-&gt;intern<span class="org-rainbow-delimiters-depth-2">(</span>env, <span class="org-string">"message"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-type">emacs_value</span> *<span class="org-variable-name">string</span> = env-&gt;make_string<span class="org-rainbow-delimiters-depth-2">(</span>env, CMOD_VERSION, <span class="org-highlight-numbers-number">3</span><span class="org-rainbow-delimiters-depth-2">)</span>;
env-&gt;funcall<span class="org-rainbow-delimiters-depth-2">(</span>env, message, <span class="org-highlight-numbers-number">1</span>, CMOD_VERSION<span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-keyword">return</span> string;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
This function is the entry point of our module and is run when the module is first
loaded by Emacs.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-keyword">extern</span> <span class="org-type">int</span> <span class="org-function-name">emacs_module_init</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">struct</span> <span class="org-type">emacs_runtime</span> *<span class="org-variable-name">ert</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-rainbow-delimiters-depth-1">{</span>
</pre>
</div>

<p>
Next we need to provision the module. We'll call the elisp <code>(provide)</code> function
through the C interface. If not Emacs will error with feature not provided.
</p>

<p>
First we get the Emacs environment from the Emacs run-time.
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-type">emacs_env</span> *<span class="org-variable-name">env</span> = ert-&gt;get_environment<span class="org-rainbow-delimiters-depth-1">(</span>ert<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<p>
Then we convert our feature string into a qouted lisp symbol. The nameing is important
our module is <code>cmodule.so</code> so the feature symbol <b>must</b> be named <code>cmodule</code>,
anything else will not work. Then we get a quoted symbol for the elisp provide function.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-type">emacs_value</span> <span class="org-variable-name">Qfeat</span> = env-&gt;intern <span class="org-rainbow-delimiters-depth-1">(</span>env, <span class="org-string">"cmodule"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
<span class="org-type">emacs_value</span> <span class="org-variable-name">Qprovide</span> = env-&gt;intern <span class="org-rainbow-delimiters-depth-1">(</span>env, <span class="org-string">"provide"</span><span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>


<p>
We then create an arguements array containing our feature symbol. And have the
Emacs environment call the provides function with our agruement. We also let
funcall know that we are passing one argument.
</p>

<div class="org-src-container">
<pre class="src src-C"><span class="org-type">emacs_value</span> <span class="org-variable-name">pargs</span><span class="org-rainbow-delimiters-depth-1">[]</span> = <span class="org-rainbow-delimiters-depth-1">{</span> Qfeat <span class="org-rainbow-delimiters-depth-1">}</span>;
env-&gt;funcall <span class="org-rainbow-delimiters-depth-1">(</span>env, Qprovide, <span class="org-highlight-numbers-number">1</span>, pargs<span class="org-rainbow-delimiters-depth-1">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-C">  printf<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"%s\n"</span>, CMOD_VERSION<span class="org-rainbow-delimiters-depth-1">)</span>;
  <span class="org-keyword">return</span> <span class="org-highlight-numbers-number">0</span>;
<span class="org-rainbow-delimiters-unmatched">}</span>
</pre>
</div>
</div></li>

<li><a id="org1aabd66"></a>Compiling the module<br /><div class="outline-text-3" id="text-org1aabd66">
<p>
Create a lib directory to hold our shared libraries.
</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir lib
</pre>
</div>

<p>
Now compile <code>cmodule.c</code> as a shared C library.
</p>
<div class="org-src-container">
<pre class="src src-shell">gcc -I emacs-25.2/src -fPIC -shared src/cmodule.c -o lib/cmodule.so
</pre>
</div>
</div></li>

<li><a id="orge35f44d"></a>Using our C module with Emacs.<br /><div class="outline-text-3" id="text-orge35f44d">
<p>
To test our module we'll start Emacs in batch mode then call our custom function.
</p>
<div class="org-src-container">
<pre class="src src-shell">emacs -Q -L ./lib -batch --eval <span class="org-string">"(require 'cmodule)"</span>
</pre>
</div>

<pre class="example">
0.1

</pre>
</div></li></ul>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2017-09-04 Mon 15:37</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
